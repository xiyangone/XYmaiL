# å¡å¯†æ¸…ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æ–°å¢äº†ä¸¤ä¸ªé‡è¦çš„å¡å¯†ç®¡ç†åŠŸèƒ½ï¼š

1. **è¿‡æœŸå¡å¯†è‡ªåŠ¨åˆ é™¤** - å®šæ—¶æ¸…ç†è¿‡æœŸçš„å¡å¯†
2. **å¡å¯†çŠ¶æ€é‡ç½®** - å½“ä¸´æ—¶è´¦å·è¢«åˆ é™¤æ—¶ï¼Œå…³è”çš„å¡å¯†çŠ¶æ€é‡ç½®ä¸ºæœªä½¿ç”¨

## ğŸ”§ åŠŸèƒ½è¯¦æƒ…

### 1. è¿‡æœŸå¡å¯†è‡ªåŠ¨åˆ é™¤

#### è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- **å®šæ—¶ä»»åŠ¡**: æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ‰§è¡Œ
- **æ¸…ç†å¯¹è±¡**: æ‰€æœ‰è¿‡æœŸçš„å¡å¯†ï¼ˆæ— è®ºæ˜¯å¦å·²ä½¿ç”¨ï¼‰
- **æ¸…ç†æ–¹å¼**: å®Œå…¨åˆ é™¤è¿‡æœŸå¡å¯†è®°å½•

#### æ‰‹åŠ¨æ¸…ç†
- **ç®¡ç†ç•Œé¢**: åœ¨å¡å¯†ç®¡ç†é¡µé¢ç‚¹å‡»"æ¸…ç†è¿‡æœŸå¡å¯†"æŒ‰é’®
- **APIæ¥å£**: `POST /api/cleanup/card-keys`
- **æƒé™è¦æ±‚**: åªæœ‰çš‡å¸è§’è‰²å¯ä»¥æ‰§è¡Œ

### 2. å¡å¯†çŠ¶æ€é‡ç½®

#### è§¦å‘æ¡ä»¶
- ä¸´æ—¶è´¦å·è¿‡æœŸè¢«è‡ªåŠ¨åˆ é™¤
- æ‰‹åŠ¨åˆ é™¤ä¸´æ—¶è´¦å·

#### é‡ç½®è¡Œä¸º
- å°†å¡å¯†çš„ `isUsed` çŠ¶æ€ä» `true` æ”¹ä¸º `false`
- æ¸…ç©º `usedBy` å’Œ `usedAt` å­—æ®µ
- å¡å¯†å¯ä»¥é‡æ–°ä½¿ç”¨

### 3. ä¼˜åŒ–çš„åˆ é™¤é€»è¾‘

#### æ–°çš„åˆ é™¤è§„åˆ™
- âœ… **æœªä½¿ç”¨çš„å¡å¯†**: éšæ—¶å¯ä»¥åˆ é™¤
- âœ… **å·²ä½¿ç”¨ä¸”è¿‡æœŸçš„å¡å¯†**: å¯ä»¥åˆ é™¤
- âŒ **å·²ä½¿ç”¨ä¸”æœªè¿‡æœŸçš„å¡å¯†**: ä¸èƒ½åˆ é™¤

#### å‰ç«¯æ˜¾ç¤º
- æ˜¾ç¤ºå¡å¯†çš„ä½¿ç”¨çŠ¶æ€å’Œè¿‡æœŸçŠ¶æ€
- è¿‡æœŸå¡å¯†æ˜¾ç¤ºçº¢è‰²"å·²è¿‡æœŸ"æ ‡ç­¾
- åªæœ‰å¯åˆ é™¤çš„å¡å¯†æ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’®

## ğŸš€ éƒ¨ç½²é…ç½®

### 1. é…ç½®Cloudflare Workerå®šæ—¶ä»»åŠ¡

1. **å¤åˆ¶é…ç½®æ–‡ä»¶**:
   ```bash
   cp wrangler.card-key-cleanup.example.json wrangler.card-key-cleanup.json
   ```

2. **ä¿®æ”¹é…ç½®**:
   ```json
   {
     "vars": {
       "SITE_URL": "https://your-actual-domain.com"
     },
     "d1_databases": [
       {
         "binding": "DB",
         "database_name": "your-actual-database-name",
         "database_id": "your-actual-database-id"
       }
     ]
   }
   ```

3. **éƒ¨ç½²Worker**:
   ```bash
   # è‡ªåŠ¨éƒ¨ç½²ï¼ˆåŒ…å«åœ¨ä¸»éƒ¨ç½²è„šæœ¬ä¸­ï¼‰
   pnpm dlx tsx scripts/deploy/index.ts
   
   # æˆ–å•ç‹¬éƒ¨ç½²
   pnpm dlx wrangler deploy --config wrangler.card-key-cleanup.json
   ```

### 2. éªŒè¯éƒ¨ç½²

1. **æ£€æŸ¥å®šæ—¶ä»»åŠ¡**:
   ```bash
   wrangler cron trigger --cron="0 2 * * *" card-key-cleanup-worker
   ```

2. **æ‰‹åŠ¨è§¦å‘æµ‹è¯•**:
   ```bash
   curl -X POST https://card-key-cleanup-worker.your-account.workers.dev/
   ```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æŸ¥çœ‹æ¸…ç†æ—¥å¿—

- **Cloudflare Dashboard**: Workers â†’ card-key-cleanup-worker â†’ Logs
- **å®æ—¶æ—¥å¿—**: `wrangler tail card-key-cleanup-worker`

### 2. è·å–æ¸…ç†ç»Ÿè®¡

```bash
# è·å–è¿‡æœŸå¡å¯†ç»Ÿè®¡
curl https://your-domain.com/api/cleanup/card-keys
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "success": true,
  "data": {
    "expiredCount": 5,
    "totalCount": 100,
    "lastChecked": "2024-01-01T02:00:00.000Z"
  }
}
```

## ğŸ” æ•…éšœæ’é™¤

### 1. å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ

**æ£€æŸ¥é¡¹ç›®**:
- Workeræ˜¯å¦æ­£ç¡®éƒ¨ç½²
- å®šæ—¶ä»»åŠ¡é…ç½®æ˜¯å¦æ­£ç¡®
- æ•°æ®åº“ç»‘å®šæ˜¯å¦æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**:
```bash
# é‡æ–°éƒ¨ç½²Worker
wrangler deploy --config wrangler.card-key-cleanup.json

# æ£€æŸ¥å®šæ—¶ä»»åŠ¡çŠ¶æ€
wrangler cron trigger --cron="0 2 * * *" card-key-cleanup-worker
```

### 2. æ‰‹åŠ¨æ¸…ç†å¤±è´¥

**å¸¸è§åŸå› **:
- æƒé™ä¸è¶³ï¼ˆéœ€è¦çš‡å¸è§’è‰²ï¼‰
- æ•°æ®åº“è¿æ¥é—®é¢˜
- ç½‘ç»œè¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç”¨æˆ·æƒé™
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
- é‡è¯•æ“ä½œ

### 3. å¡å¯†çŠ¶æ€æœªé‡ç½®

**æ£€æŸ¥é¡¹ç›®**:
- ä¸´æ—¶è´¦å·åˆ é™¤æ˜¯å¦æˆåŠŸ
- æ•°æ®åº“äº‹åŠ¡æ˜¯å¦å®Œæ•´
- å…³è”å…³ç³»æ˜¯å¦æ­£ç¡®

## ğŸ“ æœ€ä½³å®è·µ

### 1. å®šæœŸç›‘æ§
- æ¯å‘¨æ£€æŸ¥æ¸…ç†æ—¥å¿—
- ç›‘æ§è¿‡æœŸå¡å¯†æ•°é‡
- å…³æ³¨å¼‚å¸¸æ¸…ç†æƒ…å†µ

### 2. å¤‡ä»½ç­–ç•¥
- æ¸…ç†å‰è‡ªåŠ¨å¤‡ä»½é‡è¦æ•°æ®
- ä¿ç•™æ¸…ç†æ—¥å¿—è‡³å°‘30å¤©
- å®šæœŸå¯¼å‡ºå¡å¯†ä½¿ç”¨ç»Ÿè®¡

### 3. æ€§èƒ½ä¼˜åŒ–
- å¤§é‡å¡å¯†æ—¶åˆ†æ‰¹æ¸…ç†
- é¿å…åœ¨é«˜å³°æœŸæ‰‹åŠ¨æ¸…ç†
- ç›‘æ§æ•°æ®åº“æ€§èƒ½å½±å“

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `app/lib/card-keys.ts` - æ ¸å¿ƒæ¸…ç†é€»è¾‘
- `app/api/cleanup/card-keys/route.ts` - æ¸…ç†APIæ¥å£
- `workers/card-key-cleanup.ts` - å®šæ—¶ä»»åŠ¡Worker
- `app/admin/card-keys/page.tsx` - ç®¡ç†ç•Œé¢
- `wrangler.card-key-cleanup.example.json` - Workeré…ç½®æ¨¡æ¿
